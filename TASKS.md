# TASKS

## タスク 1: プロジェクト初期化と依存設定
- [x] Gradle（最新安定版）で Java 21 プロジェクトを初期化し、`config` `git` `diff` `agent` `translate` `writer` `pr` `cli` パッケージを作成する。
- [x] LangChain4j、Gemini クライアント、CLI パーサ、ロギング、テスト、JGit もしくは git CLI 連携の依存を追加してビルドが通るようにする。
- [x] サンプルの単体テストを追加し、ビルド／テストがローカルで実行できることを確認する。
**完了条件チェックリスト**
- [x] `./gradlew build` が成功する。
- [x] 各パッケージ配下にクラス雛形が配置されている。
- [x] Gradle Wrapper が最新安定版を指し、主要依存ライブラリが `build.gradle` に追加されている。

## タスク 2: 設定層の設計と実装
- [x] CLI 引数解析（`--mode`, `--upstream-url`, `--origin-url`, `--origin-branch`, `--translation-branch-template`, `--since`, `--dry-run`）を実装する。
- [x] 環境変数／Secrets 読み込みロジックを整備し、統合した `Config` オブジェクトを提供する。
- [x] dev/batch モード切替や dry-run フラグの挙動を単体テストで検証する。
**完了条件チェックリスト**
- [x] CLI から各オプションを指定して `Config` が期待通り生成される。
- [x] 環境変数が未設定の場合のフォールバック挙動がテストで確認されている。
- [x] dry-run 時に PR 作成や Secrets 参照が行われないことをテストで確認している。

## タスク 3: Git ワークフローと差分検出
- [x] upstream と origin の clone/fetch を実装し、origin の `main` から `sync-<upstream-short-sha>` ブランチを生成するフローを整備する（short SHA は未翻訳コミットの最新を用いる）。
- [x] upstream/main のマージ履歴を解析して未翻訳コミットを特定し、dev モードでは CLI から明示指定したコミットを優先できるようにする。
- [x] `TRANSLATION_TARGET_SHA` 環境変数が指定された場合はその短縮コミットハッシュを最優先ターゲットとして処理するフォールバックを実装する。
- [x] 翻訳ブランチに upstream/main を強制マージし、コンフリクトがあってもマージコミットを生成する処理を実装する。
- [x] マージ結果から更新ファイルを a/b/c 区分で分類し、文書ファイル（.md, .mdx, .txt, .html）のみに限定した差分メタデータを生成する。
- [x] 差分検出の結果を後段へ渡すためのデータモデルを定義し、テストでカバレッジを確保する。
**完了条件チェックリスト**
- [x] テスト用モックリポジトリで clone/fetch/branch 作成と強制マージが動作確認されている。
- [x] 未翻訳コミット検出と short SHA 生成がテストで検証されている。
- [x] `TRANSLATION_TARGET_SHA` 指定時に対象コミットが正しく切り替わる自動テストが存在する。
- [x] a/b/c 区分と文書ファイル限定ロジックがテストで確認されている。
- [x] 差分メタデータが翻訳モジュールで消費可能な形で提供されることを確認している。

## タスク 4: Agentic オーケストレーション
- [x] LangChain4j Agents チュートリアルに沿ってオーケストレーション構成を設計し、`agent` パッケージにエージェントクラスとツール登録処理を実装する。
- [x] `DiffAnalyzer`、`LineStructureAdjuster`、`Translator`、`PullRequestService` などを LangChain4j のツールとして公開し、モードごとの差分ハンドリングを定義する。
- [x] dev/batch モードそれぞれでエージェントの振る舞いを切り替える設定フローを整備し、単体テストまたは統合テストで確認する。
**完了条件チェックリスト**
- [x] Agent 初期化時に必要なツールとプロンプトが注入され、CLI から呼び出せる。
- [x] dev/batch モードによってエージェントのアクションが切り替わるテストが通る。
- [x] エージェントを介したハッピーパス（差分検出→翻訳→コミット準備）が統合テストで確認されている。

## タスク 5: 行構造解析と調整ユーティリティ
- [x] `LineStructureAnalyzer` と `LineStructureAdjuster` のインターフェースとデータモデルを定義する。
- [x] 空行／改行のみ／連続ブロックなどのケースをカバーしたロジックを実装する。
- [x] 代表的なケースをカバーするユニットテストを作成する。
**完了条件チェックリスト**
- [x] サンプル入力に対して Analyzer が期待通りのメタデータを返すテストが通る。
- [x] Adjuster が指定手順に従い行挿入／削除を正しく行うテストが通る。
- [x] 行数一致が最終的に保証されるシナリオテストが存在する。

## タスク 6: 翻訳モジュールとフォーマッタ
- [ ] LangChain4j/Gemini を用いた本番 Translator を実装し、API キーが設定されている場合は常に Gemini 呼び出しを行う。
- [ ] DiffMetadata から翻訳タスクを生成し、新規差分のみを対象に翻訳→既存訳へ安全にマージするパイプラインを構築する。
- [ ] 翻訳結果を行構造を保ったまま整形し、`DocumentWriter` で origin ワークツリーへ書き戻す処理を実装する。
- [ ] 翻訳対象ファイル数や対象コミットを CLI オプションで制限できるようにし、Gemini 呼び出しを最小限に制御する。
**完了条件チェックリスト**
- [ ] 翻訳後のテキストが原文と行数一致し、差分が git ワークツリーに反映される統合テストが通る。
- [ ] 翻訳対象の限定オプションが期待通りに動作するユニット／統合テストが通る。
- [ ] 実際に Gemini を呼び出す E2E テスト（環境変数でキーを差し替えられる形）が存在する。

## タスク 7: PR 作成・ログ・CI 連携
- [ ] 翻訳済みファイルをコミットメッセージ付きでステージング・コミットし、PR 直前のブランチ状態まで自動整備する処理を実装する。
- [ ] PR タイトル／本文テンプレートとファイル一覧生成ロジックを実装し、dry-run では内容を標準出力へプレビューする。
- [ ] ログ出力のテキスト／JSON 切替を実装する。
- [ ] GitHub Actions ワークフローを作成し、ビルド・テスト・静的解析・`--mode batch` 実行までカバーする。
- [ ] dev モードで `TRANSLATION_TARGET_SHA` や対象ファイル数を切り替える統合テストを自動化する。
**完了条件チェックリスト**
- [ ] 翻訳結果がコミットされた `sync-*` ブランチを dry-run で確認できる統合テストが通る。
- [ ] PR テンプレート出力が仕様通りであることを検証するテストが存在する。
- [ ] ログ形式の切替が CLI オプションまたは設定で制御できることを確認する自動テストが通る。
- [ ] Actions ワークフローがローカル検証またはレビューで妥当性確認されている。
